name: Deploy to Server

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Deploy to Server
      uses: appleboy/ssh-action@v0.1.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USERNAME }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        script: |
          echo "üöÄ Starting deployment process..."
          
          # –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–µ—Ä–≤–µ—Ä–µ
          echo "üìä Server Info:"
          echo "   Hostname: $(hostname)"
          echo "   User: $(whoami)"
          echo "   Directory: $(pwd)"
          
          cd ~/airbureau
          echo "üìÅ Project directory: $(pwd)"
          
          # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–µ—Ä–≤–∏—Å
          echo "üõë Stopping bybit-linear-ticker service..."
          sudo systemctl stop bybit-linear-ticker.service || echo "Service was not running"
          
          # –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–¥
          echo "üì• Pulling latest code..."
          git fetch origin
          git reset --hard origin/main
          
          
          # –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ
          echo "üêç Setting up Python environment..."
          if [ ! -d "venv" ]; then
            python3 -m venv venv
            echo "‚úÖ Virtual environment created"
          fi
          
          source venv/bin/activate
          pip install --upgrade pip
          echo "üì¶ Installing dependencies..."
          pip install -r requirements.txt
          
          # –û–±–Ω–æ–≤–ª—è–µ–º systemd
          echo "üîÑ Reloading systemd..."
          sudo systemctl daemon-reload
          
          # –ó–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–∏—Å
          echo "üöÄ Starting bybit-linear-ticker service..."
          sudo systemctl start bybit-linear-ticker.service
          sudo systemctl enable bybit-linear-ticker.service
          
          # –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞
          echo "‚è≥ Waiting for service to start..."
          sleep 10
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å
          echo "‚úÖ Checking service status..."
          sudo systemctl status bybit-linear-ticker.service --no-pager
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–æ–≥–∏
          echo "üìã Checking service logs..."
          sudo journalctl -u bybit-linear-ticker.service --since "1 minute ago" --no-pager -n 20
          
          echo "üéâ Deployment completed successfully!"