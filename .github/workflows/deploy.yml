name: Deploy to Server

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Deploy to Server
      uses: appleboy/ssh-action@v0.1.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USERNAME }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        script: |
          cd ~/airbureau
          
          # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–µ—Ä–≤–∏—Å –ø–µ—Ä–µ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º
          echo "üõë Stopping bybit-linear-ticker service..."
          sudo systemctl stop bybit-linear-ticker.service || true
          
          # –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–¥
          echo "üì• Pulling latest code..."
          git pull origin main
          
          # –û–±–Ω–æ–≤–ª—è–µ–º –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ –∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
          if [ ! -d "venv" ]; then
            python3 -m venv venv
          fi
          source venv/bin/activate
          pip install --upgrade pip
          pip install -r requirements.txt
          
          # –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ systemd —Å–µ—Ä–≤–∏—Å —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ –æ–±–Ω–æ–≤–ª–µ–Ω
          echo "üîÑ Ensuring systemd service is configured..."
          sudo systemctl daemon-reload
          
          # –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–∏—Å
          echo "üöÄ Starting bybit-linear-ticker service..."
          sudo systemctl start bybit-linear-ticker.service
          sudo systemctl enable bybit-linear-ticker.service
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å
          echo "‚úÖ Checking service status..."
          sudo systemctl status bybit-linear-ticker.service --no-pager
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–æ–≥–∏ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 30 —Å–µ–∫—É–Ω–¥
          echo "üìã Checking recent logs..."
          sudo journalctl -u bybit-linear-ticker.service --since "1 minute ago" --no-pager
          
          echo "üéâ Deployment completed successfully!"